<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>심판 · 배드민턴 토너먼트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- 개발에서 SW 비활성 / 배포에서만 등록 -->
  <script>
    const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
    if ("serviceWorker" in navigator) {
      if (!isLocal) {
        window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
      } else {
        navigator.serviceWorker?.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
        caches?.keys?.().then(keys => keys.forEach(k => caches.delete(k)));
      }
    }
  </script>

  <!-- UI / SDK -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>

  <!-- Pantone Theme -->
  <style>
    :root{
      --brand-25:#fbf7f5;--brand-100:#efe3dc;--brand-200:#e3cfc4;--brand-300:#d2b6a9;
      --brand-400:#bf9b8e;--brand-500:#b18474;--brand-600:#a47864;--brand-700:#8f6655;
      --brand-800:#6f4f45;--brand-900:#4f3a32;--brand-contrast:#ffffff;
      --info-100:#e7eef5;--info-700:#0F4C81;--success-100:#e8f7ef;--success-700:#15803d;
      --danger-100:#fde7eb;--danger-700:#be3455;
      --chip-bg:var(--brand-100);--chip-fg:#3b2f2a;
    }
    .btn-primary{background:var(--brand-600);color:var(--brand-contrast)}
    .btn-primary:hover{filter:brightness(0.95)}
    .btn-outline{border:1px solid var(--brand-300);background:#fff;color:var(--brand-800)}
    .btn-outline:hover{border-color:var(--brand-400);background:var(--brand-25)}
    .brand-card{border-color:var(--brand-200)}
    .chip{background:var(--chip-bg);color:var(--chip-fg)}
    .chip-info{background:var(--info-100);color:var(--info-700)}
    .chip-success{background:var(--success-100);color:var(--success-700)}
    .chip-danger{background:var(--danger-100);color:var(--danger-700)}
    .lock-scroll{overflow:hidden}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Overlays -->
  <div id="pageLoading" class="fixed inset-0 z-50 hidden items-center justify-center bg-white/80 backdrop-blur">
    <div class="flex flex-col items-center gap-3">
      <div class="h-10 w-10 rounded-full border-4 border-slate-300 border-t-slate-700 animate-spin"></div>
      <div class="text-sm text-slate-600">로딩 중…</div>
    </div>
  </div>
  <div id="savingOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30">
    <div class="bg-white rounded-xl shadow-lg px-4 py-3 flex items-center gap-3">
      <div class="h-5 w-5 rounded-full border-2 border-slate-300 border-t-slate-700 animate-spin"></div>
      <div class="text-sm text-slate-700">저장 중…</div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-3 py-2 flex items-center justify-between">
      <h1 class="text-lg md:text-xl font-bold">⚖️ 심판 화면</h1>
      <nav class="flex items-center gap-2">
        <a href="./index.html" class="rounded px-3 py-2 btn-outline text-sm">메인</a>
      </nav>
    </div>
    <div class="max-w-5xl mx-auto px-3 pb-2">
      <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
        <select id="courtSel" class="rounded border brand-card px-2 py-2">
          <option value="">코트 선택</option>
          ${[...Array(12)].map((_,i)=>`<option value="${i+1}">${i+1} 코트</option>`).join("")}
        </select>
        <input id="pin" type="password" placeholder="팀 PIN(선택)" class="rounded border brand-card px-2 py-2" />
        <button id="btnFollow" class="rounded px-3 py-2 btn-outline">코트 자동따라가기</button>
        <select id="matchSel" class="rounded border brand-card px-2 py-2 col-span-2 md:col-span-3">
          <option value="">경기 선택</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-3 py-4 space-y-4">
    <section id="matchBox" class="rounded-2xl border brand-card bg-white shadow-sm p-3 hidden">
      <div class="flex flex-col gap-2">
        <div class="flex items-start justify-between gap-3">
          <div class="text-base md:text-lg font-semibold" id="title"></div>
          <div class="flex items-center gap-2">
            <span id="badgeStage" class="chip px-2 py-0.5 rounded text-xs"></span>
            <span id="badgeCourt" class="chip px-2 py-0.5 rounded text-xs"></span>
            <span id="badgeStatus" class="chip px-2 py-0.5 rounded text-xs"></span>
          </div>
        </div>
        <div class="text-xs text-slate-500" id="meta"></div>

        <!-- Scoreboard -->
        <div id="setsWrap" class="mt-3 grid grid-cols-1 gap-3"></div>

        <!-- Controls -->
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="btnQuickA" class="rounded px-3 py-2 btn-outline text-sm">A팀 승리(자동)</button>
          <button id="btnQuickB" class="rounded px-3 py-2 btn-outline text-sm">B팀 승리(자동)</button>
        </div>
        <div class="mt-2 flex items-center gap-2">
          <button id="btnStart" class="rounded px-3 py-2 btn-outline">시작(live)</button>
          <button id="btnEnd" class="rounded px-3 py-2 btn-outline">종료(done)</button>
          <button id="btnFinal" class="rounded px-3 py-2 btn-outline">완료 토글</button>
          <button id="btnSave" class="ml-auto rounded px-4 py-2 btn-primary">저장</button>
        </div>
      </div>
    </section>

    <section class="rounded-2xl border brand-card bg-white shadow-sm p-3">
      <h2 class="font-semibold mb-2">코트 배정된 경기</h2>
      <div id="courtMatches" class="grid grid-cols-1 min-[600px]:grid-cols-2 gap-2"></div>
    </section>
  </main>

  <script>
    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");
    const startPage = () => { $("#pageLoading").classList.remove("hidden"); document.body.classList.add("lock-scroll"); };
    const endPage = () => { $("#pageLoading").classList.add("hidden"); document.body.classList.remove("lock-scroll"); };
    const startSaving = () => { $("#savingOverlay").classList.remove("hidden"); document.body.classList.add("lock-scroll"); };
    const endSaving = () => { $("#savingOverlay").classList.add("hidden"); document.body.classList.remove("lock-scroll"); };

    const sb = supabase.createClient(window.APP_CONFIG.SUPABASE_URL, window.APP_CONFIG.SUPABASE_ANON_KEY);

    // state
    let currentMatch = null;
    let teamsMap = new Map();

    const badge = (txt, cls="chip") => `<span class="${cls} px-2 py-0.5 rounded text-xs">${txt}</span>`;
    const tn = (id) => teamsMap.get(id) || `#${id}`;

    function applyDeuceRule(a,b,ptw){
      a=Math.max(0,Number(a||0)); b=Math.max(0,Number(b||0));
      const mx=Math.max(a,b), mn=Math.min(a,b);
      if(mx<=ptw){ a=Math.min(a,ptw); b=Math.min(b,ptw); }
      else if(mx-mn>1){ if(a>b) a=b+1; else b=a+1; }
      return [a,b];
    }
    function clampPair(mid,setNo,ptw){
      const ia=document.getElementById(`sa_${mid}_${setNo}`);
      const ib=document.getElementById(`sb_${mid}_${setNo}`);
      if(!ia||!ib) return;
      const [na,nb]=applyDeuceRule(ia.value,ib.value,ptw);
      ia.value=na; ib.value=nb;
    }
    function bump(mid,setNo,da,db,ptw=25){
      const ia=document.getElementById(`sa_${mid}_${setNo}`);
      const ib=document.getElementById(`sb_${mid}_${setNo}`);
      if(!ia||!ib) return;
      const a=Math.max(0,Number(ia.value||0)+(da||0));
      const b=Math.max(0,Number(ib.value||0)+(db||0));
      const [na,nb]=applyDeuceRule(a,b,ptw);
      ia.value=na; ib.value=nb;
    }

    function setCard(m){
      const ptw = Number(m.points_to_win || 25);
      let html = "";
      for(let i=1;i<=m.best_of;i++){
        html += `
          <div class="rounded-xl border brand-card bg-[color:var(--brand-25)] p-3">
            <div class="text-[11px] md:text-xs font-medium text-slate-600 mb-2">S${i}</div>
            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-lg border brand-card bg-white p-3">
                <div class="text-sm font-semibold mb-2 truncate">${tn(m.team_a_id)}</div>
                <div class="flex items-center gap-2">
                  <button type="button" class="px-3 py-2 text-base rounded border brand-card" onclick="bump(${m.id},${i},-1,0,${ptw})">−</button>
                  <input id="sa_${m.id}_${i}" type="number" min="0" class="w-20 rounded border brand-card text-center text-xl"
                         oninput="clampPair(${m.id},${i},${ptw})" />
                  <button type="button" class="px-3 py-2 text-base rounded border brand-card" onclick="bump(${m.id},${i},+1,0,${ptw})">＋</button>
                </div>
              </div>
              <div class="rounded-lg border brand-card bg-white p-3">
                <div class="text-sm font-semibold mb-2 truncate">${tn(m.team_b_id)}</div>
                <div class="flex items-center gap-2">
                  <button type="button" class="px-3 py-2 text-base rounded border brand-card" onclick="bump(${m.id},${i},0,-1,${ptw})">−</button>
                  <input id="sb_${m.id}_${i}" type="number" min="0" class="w-20 rounded border brand-card text-center text-xl"
                         oninput="clampPair(${m.id},${i},${ptw})" />
                  <button type="button" class="px-3 py-2 text-base rounded border brand-card" onclick="bump(${m.id},${i},0,+1,${ptw})">＋</button>
                </div>
              </div>
            </div>
          </div>`;
      }
      return html;
    }

    async function fillTeams(){
      const { data } = await sb.from("teams").select("id,name");
      teamsMap = new Map((data||[]).map(t=>[t.id,t.name]));
    }

    async function loadMatch(mid){
      if(!mid) { currentMatch = null; hide($("#matchBox")); return; }
      const { data: mArr } = await sb.from("matches").select("*").eq("id", mid).limit(1);
      const m = mArr?.[0]; if(!m){ currentMatch=null; hide($("#matchBox")); return; }
      currentMatch = m;

      $("#title").innerHTML = `${tn(m.team_a_id)} <span class="text-slate-500">vs</span> ${tn(m.team_b_id)}`;
      $("#badgeStage").innerHTML = (m.group_id ? "조별" : (m.stage||"").toUpperCase());
      $("#badgeCourt").innerHTML = (m.court_no ? `${m.court_no}코트` : "코트 미지정");
      $("#badgeStatus").innerHTML =
        m.status==="live" ? "진행중" : (m.is_final ? "완료" : (["done","ended","finished"].includes(m.status) ? "종료" : "대기"));
      $("#meta").innerText = `목표 ${m.points_to_win}${m.win_by?`(+${m.win_by})`:""}${m.cap?` / cap ${m.cap}`:""}, BO${m.best_of}` +
                             (m.scheduled_at?` · ${new Date(m.scheduled_at).toLocaleString()}`:"");

      $("#setsWrap").innerHTML = setCard(m);
      show($("#matchBox"));

      // load set scores
      const { data: ss } = await sb.from("match_sets").select("set_no,score_a,score_b").eq("match_id", m.id).order("set_no");
      for(const s of ss||[]){
        const ia = document.getElementById(`sa_${m.id}_${s.set_no}`);
        const ib = document.getElementById(`sb_${m.id}_${s.set_no}`);
        if(ia) ia.value = s.score_a;
        if(ib) ib.value = s.score_b;
      }

      // quick buttons
      $("#btnQuickA").onclick = () => quickWin(m.id, "A", m.best_of, Number(m.points_to_win||25));
      $("#btnQuickB").onclick = () => quickWin(m.id, "B", m.best_of, Number(m.points_to_win||25));
      $("#btnStart").onclick  = async ()=>{ await sb.from("matches").update({ status:"live" }).eq("id", m.id); await loadMatch(m.id); };
      $("#btnEnd").onclick    = async ()=>{ await sb.from("matches").update({ status:"done" }).eq("id", m.id); await loadMatch(m.id); };
      $("#btnFinal").onclick  = async ()=>{ await sb.from("matches").update({ is_final: !m.is_final }).eq("id", m.id); await loadMatch(m.id); };
      $("#btnSave").onclick   = (e)=> saveSets(e, m.id, m.best_of);
    }

    function firstEditableSet(mid,bestOf){
      for(let s=1;s<=bestOf;s++){
        const ia=document.getElementById(`sa_${mid}_${s}`); const ib=document.getElementById(`sb_${mid}_${s}`);
        if(ia&&ib&&(!ia.value&&!ib.value)) return s;
      }
      return 1;
    }
    function quickWin(mid,which,bestOf,ptw=25){
      const s = firstEditableSet(mid,bestOf);
      const ia=document.getElementById(`sa_${mid}_${s}`); const ib=document.getElementById(`sb_${mid}_${s}`);
      if(!ia||!ib) return;
      if(which==='A'){ ia.value=ptw; ib.value=Math.min(Number(ib.value||0), ptw-1); }
      else{ ib.value=ptw; ia.value=Math.min(Number(ia.value||0), ptw-1); }
      clampPair(mid,s,ptw);
    }

    async function saveSets(e, mid, bestOf){
      e?.preventDefault?.(); e?.stopPropagation?.();
      const pin = $("#pin").value || null;
      const actor = "referee";
      startSaving();
      try{
        const calls=[];
        for(let s=1;s<=bestOf;s++){
          const sa = parseInt(document.getElementById(`sa_${mid}_${s}`)?.value || "0", 10);
          const sbv = parseInt(document.getElementById(`sb_${mid}_${s}`)?.value || "0", 10);
          calls.push(sb.rpc("upsert_score_by_pin", { p_match_id:mid, p_set_no:s, p_score_a:sa, p_score_b:sbv, p_pin:pin, p_actor:actor }));
        }
        const res = await Promise.allSettled(calls);
        if(res.some(r=>r.status==="rejected" || r.value?.error)) alert("일부 저장 실패. PIN/권한 확인");
      } finally {
        endSaving();
      }
    }

    async function fillMatchSelect(court){
      // 코트 필터(진행중/대기인 미완료 경기 우선)
      let q = sb.from("matches").select("*").neq("is_final", true).order("status", { ascending:true }).order("id");
      if (court) q = q.eq("court_no", court);
      const { data } = await q;
      const sel = $("#matchSel");
      sel.innerHTML = `<option value="">경기 선택</option>` + (data||[]).map(m => `<option value="${m.id}">#${m.id} · ${(m.stage||"").toUpperCase()} · ${tn(m.team_a_id)} vs ${tn(m.team_b_id)} ${m.court_no?`· ${m.court_no}코트`:""}</option>`).join("");
    }

    async function listCourtMatches(court){
      let q = sb.from("matches").select("*").order("status").order("id");
      if (court) q = q.eq("court_no", court);
      const { data } = await q;
      const host = $("#courtMatches");
      const cards = (data||[]).map(m => `
        <div class="rounded border brand-card bg-white p-3">
          <div class="font-medium">${tn(m.team_a_id)} <span class="text-slate-500">vs</span> ${tn(m.team_b_id)}</div>
          <div class="text-xs text-slate-500 mt-1">#${m.id} · ${(m.stage||"").toUpperCase()} · ${m.court_no?`${m.court_no}코트`:"-"}</div>
          <div class="mt-2 flex gap-2">
            <button class="rounded px-2 py-1 btn-outline text-xs" onclick="gotoMatch(${m.id})">열기</button>
            <button class="rounded px-2 py-1 btn-outline text-xs" onclick="setLive(${m.id})">시작</button>
            <button class="rounded px-2 py-1 btn-outline text-xs" onclick="setDone(${m.id})">종료</button>
          </div>
        </div>`).join("");
      host.innerHTML = cards || `<div class="text-slate-500">경기 없음</div>`;
    }

    // inline actions
    window.gotoMatch = (mid)=>{ $("#matchSel").value = String(mid); loadMatch(mid); };
    window.setLive = async (mid)=>{ await sb.from("matches").update({status:"live"}).eq("id",mid); await loadMatch(mid); };
    window.setDone = async (mid)=>{ await sb.from("matches").update({status:"done"}).eq("id",mid); await loadMatch(mid); };

    // follow court (auto pick top-priority)
    let follow = false;
    async function followTick(){
      if(!follow) return;
      const c = parseInt($("#courtSel").value||"0",10)||null;
      if(!c) return;
      // 라이브 > 대기 순으로 우선
      const { data } = await sb.from("matches").select("*").eq("court_no", c).neq("is_final", true).order("status").order("id").limit(1);
      const mid = data?.[0]?.id;
      if(mid && String($("#matchSel").value)!==String(mid)){ $("#matchSel").value=String(mid); await loadMatch(mid); }
    }
    setInterval(followTick, 2000);

    // realtime
    function subscribeRealtime(){
      sb.channel("ref")
        .on("postgres_changes",{event:"*",schema:"public",table:"match_sets"}, payload=>{
          if(currentMatch && payload.new?.match_id===currentMatch.id) loadMatch(currentMatch.id);
        })
        .on("postgres_changes",{event:"*",schema:"public",table:"matches"}, payload=>{
          const c = parseInt($("#courtSel").value||"0",10)||null;
          if (c && (payload.new?.court_no===c || payload.old?.court_no===c)) {
            listCourtMatches(c);
          }
          if(currentMatch && payload.new?.id===currentMatch.id) loadMatch(currentMatch.id);
        })
        .subscribe();
    }

    // events
    $("#courtSel").addEventListener("change", async (e)=>{
      const c = parseInt(e.target.value||"0",10)||null;
      await fillMatchSelect(c);
      await listCourtMatches(c);
    });
    $("#matchSel").addEventListener("change", async (e)=>{ const mid = parseInt(e.target.value||"0",10)||null; await loadMatch(mid); });
    $("#btnFollow").addEventListener("click", ()=>{
      follow = !follow;
      $("#btnFollow").textContent = follow ? "자동따라가기: ON" : "코트 자동따라가기";
    });

    // bootstrap
    (async ()=>{
      startPage();
      try{
        // 팀 캐시
        await fillTeams();
        // URL 매치 파라미터 우선
        const url = new URL(location.href);
        const midParam = parseInt(url.searchParams.get("match")||"0",10) || null;
        if (midParam){
          await fillMatchSelect(null);
          $("#matchSel").value = String(midParam);
          await loadMatch(midParam);
        } else {
          await fillMatchSelect(null);
          await listCourtMatches(null);
        }
        subscribeRealtime();
      } finally { endPage(); }
    })();
  </script>
</body>
</html>
